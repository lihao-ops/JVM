# ç¬¬7ç«  è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶

> **å¯¹åº”ä¹¦ç±**: ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ç¬¬7ç«   
> **æ ¸å¿ƒä¸»é¢˜**: ç±»åŠ è½½æ—¶æœºã€ç±»åŠ è½½è¿‡ç¨‹ã€ç±»åŠ è½½å™¨ã€åŒäº²å§”æ´¾æ¨¡å‹

---

## ğŸ“– æ ¸å¿ƒå†…å®¹æ¦‚è¿°

### 7.1 ç±»çš„ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠ è½½   â”‚ éªŒè¯   â”‚ å‡†å¤‡   â”‚ è§£æ    â”‚ åˆå§‹åŒ–   â”‚â”€â”€â†’ ä½¿ç”¨ â”€â”€â†’ å¸è½½
â”‚Loadingâ”‚Verify â”‚Prepareâ”‚Resolve â”‚Initializeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€ è¿æ¥ (Linking) â”€â”€â”€â”€â”€â”€â”€â”˜
```

| é˜¶æ®µ | ä¸»è¦å·¥ä½œ |
| :--- | :--- |
| **åŠ è½½** | è¯»å–å­—èŠ‚ç ï¼Œç”Ÿæˆ Class å¯¹è±¡ |
| **éªŒè¯** | ç¡®ä¿å­—èŠ‚ç ç¬¦åˆè§„èŒƒï¼Œä¸å±å®³ JVM |
| **å‡†å¤‡** | ä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œè®¾ç½®é›¶å€¼ |
| **è§£æ** | ç¬¦å·å¼•ç”¨ â†’ ç›´æ¥å¼•ç”¨ |
| **åˆå§‹åŒ–** | æ‰§è¡Œ `<clinit>` æ–¹æ³•ï¼ˆé™æ€å—ã€é™æ€å˜é‡èµ‹å€¼ï¼‰ |

### 7.2 ç±»åˆå§‹åŒ–æ—¶æœºï¼ˆä¸»åŠ¨ä½¿ç”¨ï¼‰

ä»¥ä¸‹æƒ…å†µä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼š

1. **new å®ä¾‹åŒ–å¯¹è±¡**
2. **è®¿é—®é™æ€å­—æ®µ**ï¼ˆé final å¸¸é‡ï¼‰
3. **è°ƒç”¨é™æ€æ–¹æ³•**
4. **åå°„è°ƒç”¨** (`Class.forName`)
5. **åˆå§‹åŒ–å­ç±»å‰å…ˆåˆå§‹åŒ–çˆ¶ç±»**
6. **åŒ…å« main() æ–¹æ³•çš„ä¸»ç±»**
7. **MethodHandle è§£æçš„æ–¹æ³•å¥æŸ„**

### 7.3 ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼ˆè¢«åŠ¨ä½¿ç”¨ï¼‰

1. é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µ
2. é€šè¿‡æ•°ç»„å®šä¹‰å¼•ç”¨ç±»
3. å¼•ç”¨ç±»çš„å¸¸é‡ï¼ˆfinal staticï¼Œç¼–è¯‘æœŸä¼˜åŒ–ï¼‰

### 7.4 ç±»åŠ è½½å™¨å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Bootstrap ClassLoader (å¯åŠ¨ç±»åŠ è½½å™¨)             â”‚
â”‚             åŠ è½½: rt.jar, resources.jar ç­‰æ ¸å¿ƒåº“            â”‚
â”‚             ç”± C++ å®ç°ï¼Œåœ¨ Java ä¸­è¿”å› null                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Extension ClassLoader (æ‰©å±•ç±»åŠ è½½å™¨)            â”‚
â”‚              åŠ è½½: $JAVA_HOME/lib/ext ç›®å½•                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             Application ClassLoader (åº”ç”¨ç±»åŠ è½½å™¨)           â”‚
â”‚             åŠ è½½: classpath æŒ‡å®šçš„ç±»                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Custom ClassLoader (è‡ªå®šä¹‰ç±»åŠ è½½å™¨)             â”‚
â”‚              åŠ è½½: ç”¨æˆ·æŒ‡å®šè·¯å¾„çš„ç±»                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 åŒäº²å§”æ´¾æ¨¡å‹

```java
protected Class<?> loadClass(String name, boolean resolve) {
    // 1. æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½
    Class<?> c = findLoadedClass(name);
    if (c == null) {
        try {
            // 2. å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
            if (parent != null) {
                c = parent.loadClass(name, false);
            } else {
                c = findBootstrapClassOrNull(name);
            }
        } catch (ClassNotFoundException e) {
            // çˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½
        }
        if (c == null) {
            // 3. è‡ªå·±å°è¯•åŠ è½½
            c = findClass(name);
        }
    }
    return c;
}
```

**ä¼˜ç‚¹**:
- é¿å…ç±»çš„é‡å¤åŠ è½½
- ä¿æŠ¤æ ¸å¿ƒç±»åº“å®‰å…¨ï¼ˆä¸èƒ½è‡ªå®šä¹‰ java.lang.Objectï¼‰

---

## ğŸ’» ä»£ç å®è·µæ¸…å•

### å®éªŒ1: ä¸»åŠ¨ä½¿ç”¨ - new å…³é”®å­—

```bash
GET /chapter07/active-use-new
```

**å®éªŒä»£ç **: `Chapter07Controller.java:31`

### å®éªŒ2: é™æ€å­—æ®µ vs å¸¸é‡

```bash
GET /chapter07/active-use-static-field
```

**å®éªŒä»£ç **: `Chapter07Controller.java:43`

```java
// è®¿é—®é™æ€å­—æ®µ -> è§¦å‘åˆå§‹åŒ–
int value = StaticFieldClass.VALUE;

// è®¿é—®å¸¸é‡ -> ä¸è§¦å‘åˆå§‹åŒ–ï¼ˆç¼–è¯‘æœŸå†…è”ï¼‰
String constant = ConstantClass.CONSTANT;
```

### å®éªŒ3: è¢«åŠ¨ä½¿ç”¨ - å­ç±»å¼•ç”¨çˆ¶ç±»å­—æ®µ

```bash
GET /chapter07/passive-use-parent
```

**å®éªŒä»£ç **: `Chapter07Controller.java:72`

### å®éªŒ4: è¢«åŠ¨ä½¿ç”¨ - æ•°ç»„å®šä¹‰

```bash
GET /chapter07/passive-use-array
```

**å®éªŒä»£ç **: `Chapter07Controller.java:85`

### å®éªŒ5: ç±»åŠ è½½å™¨å±‚æ¬¡

```bash
GET /chapter07/classloader-hierarchy
```

**å®éªŒä»£ç **: `Chapter07Controller.java:123`

### å®éªŒ6: è‡ªå®šä¹‰ç±»åŠ è½½å™¨

```bash
GET /chapter07/custom-classloader
```

**å®éªŒä»£ç **: `Chapter07Controller.java:145`

### å®éªŒ7: æ‰“ç ´åŒäº²å§”æ´¾

```bash
GET /chapter07/break-parent-delegation
```

**å®éªŒä»£ç **: `Chapter07Controller.java:165`

### å®éªŒ8: ç±»å¸è½½æ¼”ç¤º

```bash
# VM å‚æ•°
-XX:+TraceClassUnloading

GET /chapter07/class-unloading
```

**å®éªŒä»£ç **: `Chapter07Controller.java:187`

---

## ğŸ­ ç”Ÿäº§å®è·µå»ºè®®

### 1. è‡ªå®šä¹‰ç±»åŠ è½½å™¨åœºæ™¯

```java
// åœºæ™¯ 1: çƒ­éƒ¨ç½²ï¼ˆä¿®æ”¹åä¸é‡å¯ï¼‰
public class HotSwapClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) {
        byte[] classData = loadClassDataFromDisk(name);  // é‡æ–°è¯»å–
        return defineClass(name, classData, 0, classData.length);
    }
}

// åœºæ™¯ 2: ç±»éš”ç¦»ï¼ˆä¸åŒç‰ˆæœ¬å…±å­˜ï¼‰
// Tomcat æ¯ä¸ª WebApp æœ‰ç‹¬ç«‹çš„ ClassLoader
// OSGi æ¨¡å—åŒ–ç³»ç»Ÿ

// åœºæ™¯ 3: åŠ å¯†ä¿æŠ¤
public class DecryptingClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) {
        byte[] encrypted = readFromJar(name);
        byte[] decrypted = decrypt(encrypted);  // è§£å¯†
        return defineClass(name, decrypted, 0, decrypted.length);
    }
}
```

### 2. æ‰“ç ´åŒäº²å§”æ´¾çš„åœºæ™¯

| åœºæ™¯ | å®ç°æ–¹å¼ | å…¸å‹æ¡ˆä¾‹ |
| :--- | :--- | :--- |
| **SPI æœºåˆ¶** | çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ | JDBCã€JNDI |
| **çƒ­éƒ¨ç½²** | è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œä¸å§”æ´¾çˆ¶ç±» | JRebel |
| **æ¨¡å—åŒ–** | å¹³çº§åŠ è½½å™¨ï¼Œç›¸äº’å¯è§ | OSGi |

```java
// SPI ç¤ºä¾‹ï¼šJDBC é©±åŠ¨åŠ è½½
// Bootstrap åŠ è½½ DriverManager
// ä½†é©±åŠ¨å®ç°åœ¨ classpathï¼Œéœ€è¦ App ClassLoader åŠ è½½
Thread.currentThread().setContextClassLoader(appClassLoader);
ServiceLoader<Driver> drivers = ServiceLoader.load(Driver.class);
```

### 3. ç±»åŠ è½½æ­»é”é¢„é˜²

```java
// é—®é¢˜ï¼šä¸¤ä¸ªç±»åŠ è½½å™¨äº’ç›¸ç­‰å¾…
// ClassLoader A åŠ è½½ç±» Xï¼ŒX å¼•ç”¨ç±» Yï¼ˆç”± B åŠ è½½ï¼‰
// ClassLoader B åŠ è½½ç±» Yï¼ŒY å¼•ç”¨ç±» Xï¼ˆç”± A åŠ è½½ï¼‰

// è§£å†³ï¼šä½¿ç”¨ ClassLoader.registerAsParallelCapable()
// JDK7+ è‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†æƒ…å†µ
```

### 4. ç±»å¸è½½æ¡ä»¶

```
ç±»å¸è½½éœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
1. è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹éƒ½è¢« GC
2. åŠ è½½è¯¥ç±»çš„ ClassLoader è¢« GC
3. è¯¥ç±»çš„ Class å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨
```

```java
// éªŒè¯ç±»å¸è½½
WeakReference<Class<?>> classRef = new WeakReference<>(loadedClass);
loader = null;
loadedClass = null;
System.gc();
// classRef.get() == null è¡¨ç¤ºç±»å·²å¸è½½
```

---

## ğŸ¯ é¢è¯•è€ƒç‚¹æç‚¼

### é«˜é¢‘é—®é¢˜

1. **"ç±»åŠ è½½çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"**
   - åŠ è½½ â†’ éªŒè¯ â†’ å‡†å¤‡ â†’ è§£æ â†’ åˆå§‹åŒ–
   - éªŒè¯/å‡†å¤‡/è§£æåˆç§°"è¿æ¥"

2. **"ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"**
   - å…ˆå§”æ´¾çˆ¶åŠ è½½å™¨ï¼Œçˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶è‡ªå·±åŠ è½½
   - å¥½å¤„ï¼šé¿å…é‡å¤åŠ è½½ã€ä¿æŠ¤æ ¸å¿ƒç±»åº“

3. **"å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ"**
   - é‡å†™ `loadClass()` æ–¹æ³•ï¼Œä¸è°ƒç”¨ `parent.loadClass()`
   - ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
   - å…¸å‹åœºæ™¯ï¼šJDBC SPIã€Tomcatã€OSGi

4. **"ç±»çš„åŠ è½½æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ"**
   - newã€åå°„ã€é™æ€å­—æ®µ/æ–¹æ³•ã€å­ç±»åˆå§‹åŒ–ã€main ç±»
   - å¸¸é‡å¼•ç”¨ã€æ•°ç»„å®šä¹‰ã€å­ç±»å¼•ç”¨çˆ¶ç±»å­—æ®µä¸ä¼šåˆå§‹åŒ–

5. **"å‡†å¤‡é˜¶æ®µå’Œåˆå§‹åŒ–é˜¶æ®µçš„åŒºåˆ«ï¼Ÿ"**
   - å‡†å¤‡ï¼šåˆ†é…å†…å­˜ï¼Œè®¾ç½®é›¶å€¼
   - åˆå§‹åŒ–ï¼šæ‰§è¡Œ `<clinit>`ï¼Œèµ‹å€¼çœŸå®å€¼

### è¿›é˜¶é—®é¢˜

6. **"Tomcat ä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ"**
   - éš”ç¦»ä¸åŒ WebApp çš„ç±»
   - å…è®¸ä¸åŒ WebApp ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„åº“

7. **"å¦‚ä½•å®ç°çƒ­éƒ¨ç½²ï¼Ÿ"**
   - è‡ªå®šä¹‰ ClassLoader
   - ä¸ç¼“å­˜å·²åŠ è½½çš„ç±»
   - æ¯æ¬¡åŠ è½½ä½¿ç”¨æ–°çš„ ClassLoader å®ä¾‹

8. **"ç±»å¸è½½çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ"**
   - ç±»çš„æ‰€æœ‰å®ä¾‹è¢« GC
   - ClassLoader è¢« GC
   - Class å¯¹è±¡æ— å¼•ç”¨

---

## ğŸ“š ç›¸å…³èµ„æº

- ä¹¦ç±ç« èŠ‚: ã€Šæ·±å…¥ç†è§£JVMã€‹ç¬¬7ç«  7.1-7.4
- è¾…åŠ©ç±»: `CustomLoadedClass.java`ã€`SameNameClass.java`ã€`UnloadableClass.java`
- å¼‚å¸¸åœºæ™¯: `exceptionlab/scenario/MetaspaceOomScenario.java`
