# ç¬¬4ç«  è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ã€æ•…éšœå¤„ç†å·¥å…·

> **å¯¹åº”ä¹¦ç±**: ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ç¬¬4ç«   
> **æ ¸å¿ƒä¸»é¢˜**: JDK å‘½ä»¤è¡Œå·¥å…·ã€å¯è§†åŒ–å·¥å…·ã€æ•…éšœæ’æŸ¥æ–¹æ³•è®º

---

## ğŸ“– æ ¸å¿ƒå†…å®¹æ¦‚è¿°

### 4.1 JDK å‘½ä»¤è¡Œå·¥å…·

| å·¥å…· | åŠŸèƒ½ | æ ¸å¿ƒç”¨é€” |
| :--- | :--- | :--- |
| **jps** | è¿›ç¨‹çŠ¶æ€ | åˆ—å‡º Java è¿›ç¨‹ PID |
| **jstat** | ç»Ÿè®¡ä¿¡æ¯ | GCã€ç±»åŠ è½½ã€JIT ç¼–è¯‘ç»Ÿè®¡ |
| **jinfo** | é…ç½®ä¿¡æ¯ | æŸ¥çœ‹/ä¿®æ”¹ JVM å‚æ•° |
| **jmap** | å†…å­˜æ˜ åƒ | ç”Ÿæˆ Heap Dumpã€å¯¹è±¡ç»Ÿè®¡ |
| **jstack** | çº¿ç¨‹å¿«ç…§ | çº¿ç¨‹çŠ¶æ€ã€æ­»é”æ£€æµ‹ |
| **jcmd** | å¤šåŠŸèƒ½å·¥å…· | ç»¼åˆä¸Šè¿°åŠŸèƒ½çš„æ–°ä¸€ä»£å·¥å…· |

### 4.2 æ ¸å¿ƒå‘½ä»¤é€ŸæŸ¥

```bash
# 1. æŸ¥çœ‹ Java è¿›ç¨‹
jps -lvm

# 2. æŸ¥çœ‹ GC ç»Ÿè®¡ï¼ˆæ¯ç§’åˆ·æ–°ï¼‰
jstat -gcutil <pid> 1000

# 3. ç”Ÿæˆ Heap Dump
jmap -dump:format=b,file=heap.hprof <pid>

# 4. æŸ¥çœ‹çº¿ç¨‹æ ˆ
jstack -l <pid>

# 5. æŸ¥çœ‹ JVM å‚æ•°
jinfo -flags <pid>

# 6. JDK 9+ æ¨èä½¿ç”¨ jcmd
jcmd <pid> GC.heap_dump heap.hprof
jcmd <pid> Thread.print
jcmd <pid> VM.flags
```

### 4.3 jstat è¾“å‡ºå­—æ®µè§£æ

```bash
jstat -gcutil <pid>
# S0     S1     E      O      M     CCS    YGC   YGCT  FGC  FGCT   GCT
# 0.00  25.60  75.37  50.12  97.50  94.80   120  1.234   3  0.567  1.801
```

| å­—æ®µ | å«ä¹‰ |
| :--- | :--- |
| S0/S1 | Survivor 0/1 åŒºä½¿ç”¨ç‡ |
| E | Eden åŒºä½¿ç”¨ç‡ |
| O | Old åŒºä½¿ç”¨ç‡ |
| M | Metaspace ä½¿ç”¨ç‡ |
| YGC/YGCT | Young GC æ¬¡æ•°/ç´¯è®¡æ—¶é—´ |
| FGC/FGCT | Full GC æ¬¡æ•°/ç´¯è®¡æ—¶é—´ |

### 4.4 Arthas æ ¸å¿ƒå‘½ä»¤

```bash
# 1. çº¿ç¨‹åˆ†æ
thread -n 3              # æ˜¾ç¤º CPU å ç”¨æœ€é«˜çš„ 3 ä¸ªçº¿ç¨‹
thread -b                # æ£€æµ‹æ­»é”

# 2. å†…å­˜åˆ†æ
memory                   # å†…å­˜æ¦‚è§ˆ
heapdump /tmp/dump.hprof # å¯¼å‡º heap dump

# 3. ç›‘æ§æ–¹æ³•
watch com.example.Service methodName "{params,returnObj}" -x 2
trace com.example.Service methodName

# 4. åç¼–è¯‘
jad com.example.Service  # åç¼–è¯‘ç±»
```

---

## ğŸ’» ä»£ç å®è·µæ¸…å•

### å®éªŒ1: è·å– JVM å‚æ•°

```bash
GET /chapter04/jvm-params
```

**å®éªŒä»£ç **: `Chapter04Controller.java:35`

### å®éªŒ2: çº¿ç¨‹å¿«ç…§

```bash
GET /chapter04/thread-dump
```

**å®éªŒä»£ç **: `Chapter04Controller.java:48`

### å®éªŒ3: ç›‘æ§èšåˆ

```bash
GET /chapter04/monitor
```

**å®éªŒä»£ç **: `Chapter04Controller.java:65`

### å®éªŒ4: è¿è¡Œæ—¶ç›‘æ§é¢æ¿

```bash
GET /monitor/runtime
```

**å®éªŒä»£ç **: `RuntimeMonitorController.java:31`

### å®éªŒ5: JvmMemoryMonitor å·¥å…·ç±»

```java
// æ‰“å°å®Œæ•´å†…å­˜å¿«ç…§
JvmMemoryMonitor.printMemoryInfo("BeforeTest");

// è·å–ç»“æ„åŒ–ç›‘æ§æ•°æ®
Map<String, Object> info = JvmMemoryMonitor.getMemoryInfoMap();

// è·å– GC ç»Ÿè®¡
Map<String, Object> gcStats = JvmMemoryMonitor.getGCStats();
```

**å·¥å…·ä½ç½®**: `common/JvmMemoryMonitor.java`

---

## ğŸ­ ç”Ÿäº§å®è·µå»ºè®®

### 1. CPU 100% æ’æŸ¥æµç¨‹

```bash
# Step 1: æ‰¾åˆ° CPU é«˜çš„è¿›ç¨‹
top -c

# Step 2: æ‰¾åˆ° CPU é«˜çš„çº¿ç¨‹
top -Hp <pid>

# Step 3: çº¿ç¨‹ ID è½¬ 16 è¿›åˆ¶
printf "%x\n" <tid>

# Step 4: åœ¨ jstack ä¸­æœç´¢
jstack <pid> | grep -A 30 <tid_hex>

# æˆ–ä½¿ç”¨ Arthas ä¸€é”®å®šä½
thread -n 3
```

### 2. å†…å­˜æ³„æ¼æ’æŸ¥æµç¨‹

```bash
# Step 1: è§‚å¯Ÿ GC è¶‹åŠ¿
jstat -gcutil <pid> 1000

# Step 2: å¦‚æœ Old åŒºæŒç»­å¢é•¿ï¼Œdump åˆ†æ
jmap -dump:format=b,file=heap.hprof <pid>

# Step 3: MAT åˆ†æ
# - æ‰“å¼€ Leak Suspects
# - æŸ¥çœ‹ Dominator Tree
# - åˆ†æ GC Roots å¼•ç”¨é“¾

# Step 4: å®šä½ä»£ç 
# é€šå¸¸æ˜¯ï¼šé™æ€é›†åˆã€ç¼“å­˜ã€ThreadLocalã€èµ„æºæœªå…³é—­
```

### 3. æ­»é”æ’æŸ¥

```bash
# æ–¹å¼ä¸€ï¼šjstack
jstack <pid> | grep -A 50 "BLOCKED\|deadlock"

# æ–¹å¼äºŒï¼šArthas
thread -b

# æ–¹å¼ä¸‰ï¼šJConsole/JMC
# åœ¨ Threads æ ‡ç­¾é¡µç›´æ¥æ˜¾ç¤ºæ­»é”
```

### 4. GC é—®é¢˜æ’æŸ¥

```bash
# 1. å¼€å¯ GC æ—¥å¿—
-Xlog:gc*:file=gc.log:time,uptime:filecount=5,filesize=10m

# 2. å…³æ³¨æŒ‡æ ‡
# - Young GC é¢‘ç‡ï¼ˆ>1æ¬¡/ç§’ éœ€ä¼˜åŒ–ï¼‰
# - Young GC è€—æ—¶ï¼ˆ>100ms éœ€ä¼˜åŒ–ï¼‰
# - Full GC é¢‘ç‡ï¼ˆåº”è¯¥å¾ˆå°‘ï¼‰
# - Full GC è€—æ—¶ï¼ˆ>1s éœ€ä¼˜åŒ–ï¼‰

# 3. å¸¸è§ä¼˜åŒ–æ‰‹æ®µ
# - å¢å¤§æ–°ç”Ÿä»£
# - ä¼˜åŒ–å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
# - ä½¿ç”¨ G1/ZGC
```

### 5. ç”Ÿäº§ç›‘æ§ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æ§ä½“ç³»æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨å±‚: Micrometer + Prometheus                            â”‚
â”‚  â”œâ”€ JVM æŒ‡æ ‡: jvm_memory_*, jvm_gc_*, jvm_threads_*         â”‚
â”‚  â””â”€ ä¸šåŠ¡æŒ‡æ ‡: æ¥å£ RTã€QPSã€é”™è¯¯ç‡                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯è§†åŒ–: Grafana Dashboard                                   â”‚
â”‚  â”œâ”€ JVM ç›‘æ§é¢æ¿                                            â”‚
â”‚  â””â”€ ä¸šåŠ¡ç›‘æ§é¢æ¿                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‘Šè­¦: AlertManager                                          â”‚
â”‚  â”œâ”€ Full GC æ¬¡æ•° > 1/å°æ—¶                                   â”‚
â”‚  â”œâ”€ å †ä½¿ç”¨ç‡ > 80%                                          â”‚
â”‚  â””â”€ çº¿ç¨‹æ•° > é˜ˆå€¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ é¢è¯•è€ƒç‚¹æç‚¼

### é«˜é¢‘é—®é¢˜

1. **"çº¿ä¸Š CPU 100% æ€ä¹ˆæ’æŸ¥ï¼Ÿ"**
   - top -Hp æ‰¾çº¿ç¨‹ â†’ jstack çœ‹æ ˆ â†’ å®šä½ä»£ç 
   - æˆ– Arthas thread -n 3 ä¸€é”®å®šä½
   - å¸¸è§åŸå› ï¼šæ­»å¾ªç¯ã€æ­£åˆ™å›æº¯ã€é¢‘ç¹ GC

2. **"å†…å­˜æ³„æ¼æ€ä¹ˆæ’æŸ¥ï¼Ÿ"**
   - jstat è§‚å¯Ÿ Old åŒºè¶‹åŠ¿
   - jmap dump â†’ MAT åˆ†æ
   - å®šä½ï¼šé™æ€é›†åˆã€ThreadLocalã€æœªå…³é—­èµ„æº

3. **"Full GC é¢‘ç¹æ€ä¹ˆæ’æŸ¥ï¼Ÿ"**
   - å¼€å¯ GC æ—¥å¿—åˆ†æ
   - æ£€æŸ¥ï¼šè€å¹´ä»£å¤ªå°ã€å¤§å¯¹è±¡è¿‡å¤šã€å…ƒç©ºé—´ä¸è¶³
   - ä¼˜åŒ–ï¼šå¢å¤§å †ã€è°ƒæ•´æ™‹å‡ç­–ç•¥ã€æ›´æ¢ G1

4. **"jstack æ€ä¹ˆçœ‹çº¿ç¨‹çŠ¶æ€ï¼Ÿ"**
   - RUNNABLEï¼šè¿è¡Œä¸­
   - BLOCKEDï¼šç­‰å¾…é”
   - WAITINGï¼šwait() æˆ– join()
   - TIMED_WAITINGï¼šsleep() æˆ–å¸¦è¶…æ—¶çš„ wait

5. **"Arthas å¸¸ç”¨å‘½ä»¤æœ‰å“ªäº›ï¼Ÿ"**
   - threadï¼šçº¿ç¨‹åˆ†æ
   - jadï¼šåç¼–è¯‘
   - watch/traceï¼šæ–¹æ³•ç›‘æ§
   - heapdumpï¼šå†…å­˜åˆ†æ

### è¿›é˜¶é—®é¢˜

6. **"å¦‚ä½•åœ¨çº¿ä¸é‡å¯ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Ÿ"**
   - Arthas: logger --name ROOT --level DEBUG
   - Spring Actuator: POST /actuator/loggers/{name}

7. **"å¦‚ä½•åˆ†æ GC æ—¥å¿—ï¼Ÿ"**
   - æ—¶é—´æˆ³ã€GC ç±»å‹ã€å›æ”¶å‰åå†…å­˜ã€è€—æ—¶
   - å·¥å…·ï¼šGCViewerã€GCEasyã€JMC

---

## ğŸ“š ç›¸å…³èµ„æº

- ä¹¦ç±ç« èŠ‚: ã€Šæ·±å…¥ç†è§£JVMã€‹ç¬¬4ç«  4.1-4.4
- ç›‘æ§å·¥å…·: `common/JvmMemoryMonitor.java`
- è¿è¡Œæ—¶ç›‘æ§: `monitor/RuntimeMonitorController.java`
