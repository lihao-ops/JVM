# ExceptionLab å¼‚å¸¸å®éªŒå®¤

> **æ¨¡å—å®šä½**: JVM å†…å­˜å¼‚å¸¸åœºæ™¯çš„ç­–ç•¥æ¨¡å¼å®ç°  
> **æ ¸å¿ƒä»·å€¼**: é¢è¯•é«˜é¢‘è€ƒç‚¹çš„å¯å¤ç°å®éªŒç¯å¢ƒ

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

ExceptionLab é‡‡ç”¨**ç­–ç•¥æ¨¡å¼**è®¾è®¡ï¼Œå°† 8 ç§ JVM å¼‚å¸¸åœºæ™¯æŠ½è±¡ä¸ºç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒï¼š
- **Dry-Run æ¨¡å¼**: æŸ¥çœ‹å®éªŒæŒ‡å¼•ï¼Œä¸è§¦å‘å¼‚å¸¸
- **Real æ¨¡å¼**: çœŸå®è§¦å‘å¼‚å¸¸ï¼Œè§‚å¯Ÿç°è±¡

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             MemoryExceptionLabController                     â”‚
â”‚             /memory-exception-lab/*                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             MemoryExceptionLabService                        â”‚
â”‚             åœºæ™¯æ³¨å†Œã€è°ƒåº¦ã€æ‰§è¡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MemoryExceptionScenario (æ¥å£)                      â”‚
â”‚          + execute(params) + getMetadata() + getDetail()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HeapOomScenario â”‚ â”‚StackOverflow   â”‚ â”‚ MetaspaceOom    â”‚
â”‚                 â”‚ â”‚ Scenario       â”‚ â”‚ Scenario        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ... å…± 8 ç§åœºæ™¯å®ç° ...
```

---

## ğŸ’» 8 ç§å¼‚å¸¸åœºæ™¯

### åœºæ™¯1: HeapOomScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.OutOfMemoryError: Java heap space`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | é™æ€é›†åˆæŒæœ‰å¯¹è±¡ï¼ŒGC Roots å¯è¾¾æ— æ³•å›æ”¶ |
| **VM å‚æ•°** | `-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError` |
| **é¢è¯•è€ƒç‚¹** | å †å†…å­˜æ’æŸ¥ã€MAT åˆ†æã€å¼•ç”¨é“¾å®šä½ |
| **ç”Ÿäº§åœºæ™¯** | ç¼“å­˜æœªè®¾ç½®è¿‡æœŸã€å¤§å¯¹è±¡æœªåŠæ—¶é‡Šæ”¾ |

```bash
POST /memory-exception-lab/scenarios/heap-oom/execute?dryRun=false
```

---

### åœºæ™¯2: StackOverflowScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.StackOverflowError`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | æ— ç»ˆæ­¢é€’å½’å¯¼è‡´æ ˆå¸§è€—å°½ |
| **VM å‚æ•°** | `-Xss128k` |
| **é¢è¯•è€ƒç‚¹** | æ ˆæ·±åº¦ä¸ -Xss å…³ç³»ã€å°¾é€’å½’ä¼˜åŒ–ï¼ˆJava æ— ï¼‰ |
| **ç”Ÿäº§åœºæ™¯** | æ·±åº¦é€’å½’ç®—æ³•ã€å¾ªç¯ä¾èµ– |

```bash
POST /memory-exception-lab/scenarios/stack-overflow/execute?dryRun=false
```

---

### åœºæ™¯3: MetaspaceOomScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.OutOfMemoryError: Metaspace`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | ASM åŠ¨æ€ç”Ÿæˆç±»æ¶ˆè€—å…ƒç©ºé—´ |
| **VM å‚æ•°** | `-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m` |
| **é¢è¯•è€ƒç‚¹** | å…ƒç©ºé—´ vs æ°¸ä¹…ä»£ã€ç±»å¸è½½æ¡ä»¶ |
| **ç”Ÿäº§åœºæ™¯** | åŠ¨æ€ä»£ç†è¿‡å¤šã€JSP ç¼–è¯‘ã€Groovy è„šæœ¬ |

```bash
POST /memory-exception-lab/scenarios/metaspace-oom/execute?dryRun=false
```

---

### åœºæ™¯4: DirectMemoryOomScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.OutOfMemoryError: Direct buffer memory`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | `ByteBuffer.allocateDirect` å †å¤–å†…å­˜æœªé‡Šæ”¾ |
| **VM å‚æ•°** | `-XX:MaxDirectMemorySize=10m` |
| **é¢è¯•è€ƒç‚¹** | ç›´æ¥å†…å­˜å›æ”¶æœºåˆ¶ã€NMT åˆ†æ |
| **ç”Ÿäº§åœºæ™¯** | NIO åº”ç”¨ã€Netty å†…å­˜æ³„æ¼ |

```bash
POST /memory-exception-lab/scenarios/direct-memory-oom/execute?dryRun=false
```

---

### åœºæ™¯5: ThreadOomScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.OutOfMemoryError: unable to create new native thread`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | å¤§é‡çº¿ç¨‹åˆ›å»ºè€—å°½ç³»ç»Ÿèµ„æº |
| **VM å‚æ•°** | `-Xss256k` (å‡å°æ ˆå¯åˆ›å»ºæ›´å¤šçº¿ç¨‹) |
| **é¢è¯•è€ƒç‚¹** | çº¿ç¨‹æ•°ä¸æ ˆå¤§å°æƒè¡¡ã€ulimit é…ç½® |
| **ç”Ÿäº§åœºæ™¯** | çº¿ç¨‹æ± å¤±æ§ã€è¿æ¥æ± æ³„æ¼ |

```bash
POST /memory-exception-lab/scenarios/thread-oom/execute?dryRun=false
```

> âš ï¸ **è­¦å‘Š**: æ­¤å®éªŒå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ï¼Œè¯·è°¨æ…æ‰§è¡Œ

---

### åœºæ™¯6: StringPoolPressureScenario
**è§¦å‘ç°è±¡**: å †å†…å­˜å‹åŠ›å¢å¤§

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | æ‰¹é‡ `String.intern()` å¢é•¿å¸¸é‡æ±  |
| **VM å‚æ•°** | `-Xms20m -Xmx20m` |
| **é¢è¯•è€ƒç‚¹** | JDK7+ å¸¸é‡æ± åœ¨å †ä¸­ã€intern() åŸç† |
| **ç”Ÿäº§åœºæ™¯** | è¿‡åº¦ä½¿ç”¨ intern() ä¼˜åŒ– |

```bash
POST /memory-exception-lab/scenarios/string-pool/execute?dryRun=false
```

---

### åœºæ™¯7: GcOverheadScenario
**è§¦å‘å¼‚å¸¸**: `java.lang.OutOfMemoryError: GC overhead limit exceeded`

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | GC æ—¶é—´å æ¯”è¿‡é«˜ä½†å›æ”¶æ•ˆæœå·® |
| **VM å‚æ•°** | `-Xms10m -Xmx10m` |
| **é¢è¯•è€ƒç‚¹** | GC æ•ˆç‡ä¸å†…å­˜åˆ†é…é€Ÿç‡ã€98%/2% è§„åˆ™ |
| **ç”Ÿäº§åœºæ™¯** | å†…å­˜å³å°†è€—å°½æ—¶çš„é¢„è­¦ä¿¡å· |

```bash
POST /memory-exception-lab/scenarios/gc-overhead/execute?dryRun=false
```

---

### åœºæ™¯8: ThreadLocalLeakScenario
**è§¦å‘ç°è±¡**: å†…å­˜æ³„æ¼ï¼ˆéç«‹å³ OOMï¼‰

| é¡¹ç›® | è¯´æ˜ |
| :--- | :--- |
| **åŸç†** | ThreadLocal å€¼è¢«é™æ€é›†åˆé—´æ¥æŒæœ‰ |
| **VM å‚æ•°** | `-Xms20m -Xmx20m` |
| **é¢è¯•è€ƒç‚¹** | Entry å¼±å¼•ç”¨æœºåˆ¶ã€çº¿ç¨‹æ± å¤ç”¨é—®é¢˜ |
| **ç”Ÿäº§åœºæ™¯** | çº¿ç¨‹æ±  + ThreadLocal æœªæ¸…ç† |

```bash
POST /memory-exception-lab/scenarios/threadlocal-leak/execute?dryRun=false
```

---

## ğŸ­ ç”Ÿäº§å®è·µå»ºè®®

### 1. å„ç±» OOM å¿«é€ŸåŒºåˆ†

| OOM ç±»å‹ | é”™è¯¯ä¿¡æ¯å…³é”®è¯ | æ’æŸ¥æ–¹å‘ |
| :--- | :--- | :--- |
| å †å†…å­˜ | `Java heap space` | MAT åˆ†æ dump |
| å…ƒç©ºé—´ | `Metaspace` | ç±»åŠ è½½å™¨æ³„æ¼ |
| ç›´æ¥å†…å­˜ | `Direct buffer memory` | NMT åˆ†æå †å¤– |
| çº¿ç¨‹ | `unable to create new native thread` | æ£€æŸ¥çº¿ç¨‹æ± ã€ulimit |
| GC è¶…æ—¶ | `GC overhead limit exceeded` | åŒå †å†…å­˜é—®é¢˜ |

### 2. æ’æŸ¥å·¥å…·é€‰æ‹©

| åœºæ™¯ | æ¨èå·¥å…· | å‘½ä»¤/ç”¨æ³• |
| :--- | :--- | :--- |
| å †å†…å­˜ | MAT | æ‰“å¼€ dump åˆ†æ Dominator Tree |
| ç›´æ¥å†…å­˜ | NMT | `jcmd <pid> VM.native_memory summary` |
| çº¿ç¨‹ | jstack | `jstack <pid>` |
| é€šç”¨ | Arthas | `memory`ã€`thread`ã€`heapdump` |

### 3. é¢„é˜²æªæ–½

```java
// 1. å †å†…å­˜æ³„æ¼é¢„é˜²
// - ç¼“å­˜è®¾ç½®è¿‡æœŸæ—¶é—´
// - ä½¿ç”¨å¼±å¼•ç”¨ç¼“å­˜ WeakHashMap
// - åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡

// 2. å…ƒç©ºé—´æ³„æ¼é¢„é˜²
// - é¿å…åŠ¨æ€ç”Ÿæˆè¿‡å¤šç±»
// - ClassLoader ä½¿ç”¨åç½®ç©º

// 3. ç›´æ¥å†…å­˜æ³„æ¼é¢„é˜²
// - Netty ä½¿ç”¨æ± åŒ– ByteBuf
// - æ‰‹åŠ¨é‡Šæ”¾: ((DirectBuffer) buf).cleaner().clean()

// 4. ThreadLocal æ³„æ¼é¢„é˜²
// - ä½¿ç”¨ try-finally ç¡®ä¿ remove()
try {
    threadLocal.set(value);
    // ä¸šåŠ¡é€»è¾‘
} finally {
    threadLocal.remove();
}
```

---

## ğŸ¯ é¢è¯•é«˜é¢‘é—®é¢˜

### 1. OOM é—®é¢˜é€šç”¨å›ç­”æ¡†æ¶

```
1. å®šä½é—®é¢˜
   - çœ‹ OOM ç±»å‹ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
   - çœ‹å‘ç”Ÿæ—¶æœºï¼ˆå¯åŠ¨æ—¶/è¿è¡Œä¸­ï¼‰
   
2. æ”¶é›†ä¿¡æ¯
   - å † dump: -XX:+HeapDumpOnOutOfMemoryError
   - GC æ—¥å¿—: -Xlog:gc*
   - çº¿ç¨‹ dump: jstack
   
3. åˆ†ææ ¹å› 
   - MAT åˆ†æå¼•ç”¨é“¾
   - æ‰¾åˆ° GC Roots
   - å®šä½ä»£ç ä½ç½®
   
4. è§£å†³æ–¹æ¡ˆ
   - çŸ­æœŸï¼šå¢å¤§å†…å­˜ã€é‡å¯
   - é•¿æœŸï¼šä¿®å¤ä»£ç ã€åŠ ç›‘æ§
```

### 2. "é‡åˆ°è¿‡ä»€ä¹ˆå†…å­˜é—®é¢˜ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿ"

**å›ç­”æ¨¡æ¿**:
```
åœºæ™¯ï¼š[å…·ä½“ä¸šåŠ¡åœºæ™¯]
ç°è±¡ï¼š[OOM ç±»å‹ã€å‘ç”Ÿæ—¶æœº]
åˆ†æï¼š[ç”¨ä»€ä¹ˆå·¥å…·ã€å‘ç°ä»€ä¹ˆ]
åŸå› ï¼š[æ ¹æœ¬åŸå› ]
è§£å†³ï¼š[å¦‚ä½•ä¿®å¤]
é¢„é˜²ï¼š[å¦‚ä½•é¿å…å†æ¬¡å‘ç”Ÿ]
```

---

## ğŸ“š ç›®å½•ç»“æ„

```
exceptionlab/
â”œâ”€â”€ MemoryExceptionLabController.java  # REST æ§åˆ¶å™¨
â”œâ”€â”€ MemoryExceptionLabService.java     # æœåŠ¡å±‚ï¼ˆåœºæ™¯æ³¨å†Œä¸è°ƒåº¦ï¼‰
â”œâ”€â”€ MemoryExceptionScenario.java       # åœºæ™¯æ¥å£å®šä¹‰
â”œâ”€â”€ AbstractMemoryExceptionScenario.java  # æ¨¡æ¿æ–¹æ³•åŸºç±»
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ ScenarioMetadata.java          # åœºæ™¯å…ƒä¿¡æ¯
â”‚   â”œâ”€â”€ ScenarioDetail.java            # åœºæ™¯è¯¦æƒ…
â”‚   â””â”€â”€ ScenarioExecutionResult.java   # æ‰§è¡Œç»“æœ
â””â”€â”€ scenario/
    â”œâ”€â”€ HeapOomScenario.java
    â”œâ”€â”€ StackOverflowScenario.java
    â”œâ”€â”€ MetaspaceOomScenario.java
    â”œâ”€â”€ DirectMemoryOomScenario.java
    â”œâ”€â”€ ThreadOomScenario.java
    â”œâ”€â”€ StringPoolPressureScenario.java
    â”œâ”€â”€ GcOverheadScenario.java
    â””â”€â”€ ThreadLocalLeakScenario.java
```

---

## ğŸ“š ç›¸å…³èµ„æº

- ä¹¦ç±ç« èŠ‚: ã€Šæ·±å…¥ç†è§£JVMã€‹ç¬¬2ç« ã€ç¬¬3ç« 
- å¿«é€Ÿè§¦å‘: `jvmstress/ctrl/JvmErrorController.java`
- ç›‘æ§å·¥å…·: `common/JvmMemoryMonitor.java`
